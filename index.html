<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flappy AVELL - iOS Sound Fix</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0; padding: 0;
            background-color: #202020;
            font-family: 'Bangers', system-ui;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden; user-select: none; touch-action: none;
            transition: background-color 0.5s;
        }
        #game-container {
            position: relative; width: 400px; height: 600px;
            border: 10px solid #333; border-radius: 15px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            overflow: hidden; background-color: #000;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        
        #selection-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.95);
            display: flex; flex-direction: column;
            justify-content: flex-start; align-items: center;
            color: white; z-index: 10;
            transition: background-color 0.5s;
            overflow-y: auto; padding-top: 10px; pointer-events: auto;
        }

        .coin-display { font-size: 24px; color: gold; text-shadow: 2px 2px 0 #000; margin-bottom: 5px; letter-spacing: 1px; }
        .character-options { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 10px; max-width: 380px; padding-bottom: 20px; }
        
        .char-select {
            position: relative; width: 70px; height: 70px;
            border: 3px solid white; border-radius: 15px;
            cursor: pointer; background-color: #222; padding: 5px;
            transition: transform 0.2s;
        }
        .char-select:hover { transform: scale(1.1); border-color: gold; z-index: 2; }
        .char-select img { width: 100%; height: 100%; object-fit: contain; }

        #theme-toggle { 
            margin: 10px 0; padding: 8px 15px; 
            font-size: 18px; font-family: 'Bangers', system-ui; letter-spacing: 1px;
            border: 2px solid white; border-radius: 20px; background: #333; color: white; cursor: pointer; 
        }

        #credits { margin-top: auto; margin-bottom: 15px; font-size: 14px; color: #888; letter-spacing: 1px; opacity: 0.8; }
        
        .locked { filter: grayscale(100%) brightness(40%); cursor: pointer; border-color: #444; }
        .lock-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: gold; font-size: 14px; text-shadow: 2px 2px 0 #000; }
        .score-lock { color: red !important; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui-layer">
        <div style="position:absolute; top:10px; right:15px; color:gold; font-size:32px; text-shadow: 3px 3px 0 #000;">
            ‚öôÔ∏è <span id="game-coin-count">0</span>
        </div>
    </div>

    <div id="selection-screen">
        <h1 style="font-size: 40px; margin-bottom: 5px; text-align: center; color: #fff; text-shadow: 3px 3px 0 #39FF14; letter-spacing: 2px;">Fƒ∞LONU SE√á</h1>
        <div class="coin-display">‚öôÔ∏è <span id="menu-total-coins">0</span> Jant</div>
        <p id="menu-highscore" style="font-size: 18px; color: #ccc; margin-bottom: 10px;">En Y√ºksek Skor: 0</p>
        <div class="character-options" id="char-list"></div>
        <button id="theme-toggle" onclick="toggleTheme()">üåô Gece Modu</button>
        <p id="shop-msg" style="height: 20px; font-size: 16px; color: red; text-shadow: 1px 1px 0 #000;"></p>
        <p id="credits">Developed by Asim Emre</p>
    </div>

    <canvas id="gameCanvas" width="400" height="600"></canvas>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const selectionScreen = document.getElementById("selection-screen");
    const menuHighScoreTxt = document.getElementById("menu-highscore");
    const menuTotalCoinsTxt = document.getElementById("menu-total-coins");
    const gameCoinCountTxt = document.getElementById("game-coin-count");
    const shopMsg = document.getElementById("shop-msg");
    const themeBtn = document.getElementById("theme-toggle");
    const charListDiv = document.getElementById("char-list");

    // --- SES Sƒ∞STEMƒ∞ (iPHONE FIX) ---
    const sounds = {};
    const soundList = ["zipla", "puan", "avell", "seviye", "gay", "coin", "ses10", "ses50", "ses75", "ses100"];
    
    // Sesleri √∂nden y√ºkle
    soundList.forEach(name => {
        sounds[name] = new Audio(name + ".mp3");
        sounds[name].preload = "auto"; // Tarayƒ±cƒ±ya zorla y√ºklet
        sounds[name].onerror = () => console.log(name + " sesi bulunamadƒ±.");
    });

    // ƒ∞≈ûTE √á√ñZ√úM: ƒ∞lk tƒ±klamada t√ºm sesleri "uyandƒ±r"
    let audioUnlocked = false;
    function unlockAudio() {
        if (audioUnlocked) return;
        
        soundList.forEach(name => {
            if (sounds[name]) {
                // Sesi √ßal, sesini kƒ±s, durdur ve ba≈üa sar
                sounds[name].volume = 0; 
                let playPromise = sounds[name].play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        sounds[name].pause();
                        sounds[name].currentTime = 0;
                        sounds[name].volume = 1.0; // Sesi geri a√ß
                    }).catch(error => {});
                }
            }
        });
        audioUnlocked = true;
    }

    function playSound(name) {
        try {
            if(sounds[name]) {
                // iPhone i√ßin klonlamak yerine ana dosyayƒ± kullanmayƒ± dene (daha stabil)
                // Ama √ßoklu ses i√ßin klon ≈üart. iPhone'da klon bazen gecikir.
                let s = sounds[name].cloneNode(true);
                s.volume = 1.0; 
                s.play().catch(e=>{ console.log("Ses √ßalma hatasƒ±:", e); });
            }
        } catch(e){}
    }

    // VERƒ∞LER
    let highScore = parseInt(localStorage.getItem("avell_highscore")) || 0;
    let totalCoins = parseInt(localStorage.getItem("avell_coins")) || 0;
    let unlockedChars = JSON.parse(localStorage.getItem("avell_unlocked")) || [true, true, false, false, false, false, false];

    let isNight = true;
    let selectedBird = 1;
    let gameSpeed = 1.8;
    let lastTime = 0;

    const charConfig = [
        { id: 1, price: 0, type: 'free' }, { id: 2, price: 0, type: 'free' },
        { id: 3, price: 100, type: 'coin' }, { id: 4, price: 250, type: 'coin' },
        { id: 5, price: 500, type: 'coin' }, { id: 6, price: 1000, type: 'coin' },
        { id: 7, price: 50, type: 'score' }
    ];

    const birdImages = [];
    for(let i=1; i<=7; i++) {
        let img = new Image(); img.src = `kus${i}.png`; birdImages.push(img);
    }

    function renderShop() {
        charListDiv.innerHTML = "";
        menuTotalCoinsTxt.innerText = totalCoins;
        menuHighScoreTxt.innerText = "En Y√ºksek Skor: " + highScore;

        if(highScore >= 50 && !unlockedChars[6]) {
            unlockedChars[6] = true;
            localStorage.setItem("avell_unlocked", JSON.stringify(unlockedChars));
        }

        charConfig.forEach((cfg, index) => {
            let div = document.createElement("div");
            div.className = "char-select";
            if (!unlockedChars[index]) {
                div.classList.add("locked");
                let overlay = document.createElement("div");
                overlay.className = "lock-overlay";
                if (cfg.type === 'coin') overlay.innerHTML = `üîí<br>${cfg.price}‚öôÔ∏è`;
                else if (cfg.type === 'score') { overlay.innerHTML = `üîí<br>${cfg.price} P`; overlay.classList.add("score-lock"); }
                div.appendChild(overlay);
                div.onclick = (e) => { e.stopPropagation(); unlockAudio(); buyCharacter(index); };
            } else {
                if (selectedBird === index + 1) div.style.borderColor = "gold";
                div.onclick = (e) => { e.stopPropagation(); selectCharacter(index + 1); };
            }
            let img = document.createElement("img");
            img.src = `kus${index+1}.png`;
            img.onerror = function() { this.src='kus1.png'; }; 
            div.appendChild(img);
            if(index === 6 && unlockedChars[6]) {
                let crown = document.createElement("div");
                crown.innerHTML = "üëë"; crown.style.position="absolute"; crown.style.top="-10px"; crown.style.right="-10px";
                div.appendChild(crown);
            }
            charListDiv.appendChild(div);
        });
    }

    function buyCharacter(index) {
        unlockAudio(); // Satƒ±n alƒ±rken de sesi a√ßmayƒ± dene
        let cfg = charConfig[index];
        if (cfg.type === 'coin') {
            if (totalCoins >= cfg.price) {
                totalCoins -= cfg.price; unlockedChars[index] = true;
                localStorage.setItem("avell_coins", totalCoins);
                localStorage.setItem("avell_unlocked", JSON.stringify(unlockedChars));
                playSound('seviye'); renderShop();
                shopMsg.innerText = "Satƒ±n alƒ±ndƒ±!"; shopMsg.style.color = "gold";
            } else {
                shopMsg.innerText = "Yetersiz Jant!"; shopMsg.style.color = "red";
            }
        } else { shopMsg.innerText = "Rekor kƒ±rman lazƒ±m!"; }
    }

    function selectCharacter(num) {
        // ƒ∞≈ûTE BURADA SES Kƒ∞Lƒ∞Dƒ∞Nƒ∞ A√áIYORUZ
        unlockAudio(); 
        
        selectedBird = num;
        state.current = state.getReady;
        selectionScreen.classList.add("hidden");
        playSound('zipla');
        bird.y = canvas.height / 2 - 50;
        bird.speed = 0;
        lastTime = performance.now();
    }

    function handleInput(e) {
        if (!selectionScreen.classList.contains("hidden")) {
            unlockAudio(); // Men√ºye tƒ±klasa bile sesi a√ß
            return;
        }
        action();
    }
    
    // Her t√ºrl√º etkile≈üimde sesi uyandƒ±rmayƒ± dene
    document.addEventListener("mousedown", handleInput);
    document.addEventListener("touchstart", function(e) {
        unlockAudio(); 
        if (!selectionScreen.classList.contains("hidden")) return;
        action();
    }, {passive: false});
    
    window.addEventListener("keydown", function(e){ 
        if(e.code === "Space") {
            if (!selectionScreen.classList.contains("hidden")) return;
            action(); 
        }
    });

    let particles = [], trails = [], coins = [];
    let shakeIntensity = 0;

    function createExplosion(x, y) {
        shakeIntensity = 20;
        for (let i = 0; i < 30; i++) {
            particles.push({ x: x, y: y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 1.0, color: isNight ? `hsl(${Math.random()*60+10}, 100%, 50%)` : "orange" });
        }
    }

    const bird = {
        x: 60, y: 150, w: 50, h: 36, radius: 18, 
        speed: 0, gravity: 0.32, jump: 5.2,
        draw: function() {
            if (state.current == state.game) {
                trails.push({ x: this.x - 20, y: this.y + (Math.random() - 0.5) * 10, life: 1.0, size: 6 + Math.random() * 6 });
            }
            for (let i = 0; i < trails.length; i++) {
                let t = trails[i];
                let smokeColor = isNight ? `rgba(80, 80, 80, ${t.life * 0.4})` : `rgba(180, 180, 180, ${t.life * 0.5})`;
                ctx.fillStyle = smokeColor;
                ctx.beginPath(); ctx.arc(t.x, t.y, t.size, 0, Math.PI*2); ctx.fill();
                t.x -= 2.5; t.y += (Math.random() - 0.5) * 1; t.life -= 0.02; t.size += 0.1;
                if(t.life <= 0) { trails.splice(i, 1); i--; }
            }

            ctx.save(); ctx.translate(this.x, this.y);
            let rotation = Math.min(Math.PI/4, Math.max(-Math.PI/4, (this.speed*0.1)));
            ctx.rotate(rotation);
            let img = birdImages[selectedBird - 1];
            if (img.complete && img.naturalHeight !== 0) ctx.drawImage(img, -this.w/2, -this.h/2, this.w, this.h);
            else { ctx.fillStyle = "yellow"; ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI*2); ctx.fill(); }
            ctx.restore();
        },
        update: function(timeScale) {
            if (state.current === state.select) return;
            if (state.current === state.getReady) { this.y = canvas.height/2 - 50; this.speed = 0; }
            else { this.speed += this.gravity * timeScale; this.y += this.speed * timeScale; }
            if (this.y + this.radius >= canvas.height - 150 || (this.y - this.radius <= 0)) this.die();
        },
        flap: function() { this.speed = -this.jump; },
        die: function() {
            if (state.current == state.game) {
                createExplosion(this.x, this.y);
                if (score.value < 10) playSound('gay'); else playSound('avell');
                state.current = state.over;
            }
        },
        reset: function() { this.y = canvas.height / 2 - 50; this.speed = 0; }
    }

    const pipes = {
        position: [], w: 80, h: 600, gap: 190, capHeight: 0, spawnDistance: 240,
        draw: function() {
            let time = Date.now();
            let lightCycle = Math.floor(time / 1200) % 3; 

            for (let p of this.position) {
                let topY = p.y - this.h;
                let bottomY = p.y + p.gap;
                let poleGradient = ctx.createLinearGradient(p.x, 0, p.x + this.w, 0);
                poleGradient.addColorStop(0, "#1a1a1a"); poleGradient.addColorStop(0.2, "#4d4d4d"); poleGradient.addColorStop(0.5, "#333"); poleGradient.addColorStop(1, "#000");

                const drawTrafficLight = (yPos, height) => {
                    ctx.fillStyle = poleGradient; ctx.fillRect(p.x, yPos, this.w, height);
                    ctx.strokeStyle = "#000"; ctx.lineWidth = 2; ctx.strokeRect(p.x, yPos, this.w, height);
                    let circleSize = 15; let centerX = p.x + this.w / 2;
                    for(let ly = yPos + 30; ly < yPos + height - 30; ly += 50) {
                        let whichLight = Math.floor((ly + time/24) / 50) % 3; 
                        let color; let glow = false;
                        if (Math.abs(whichLight) === 0) { color = (lightCycle === 0) ? "#FF0000" : "#550000"; if(lightCycle===0) glow=true; }
                        else if (Math.abs(whichLight) === 1) { color = (lightCycle === 1) ? "#FFFF00" : "#555500"; if(lightCycle===1) glow=true; }
                        else { color = (lightCycle === 2) ? "#00FF00" : "#005500"; if(lightCycle===2) glow=true; }
                        ctx.fillStyle = color; if(glow && isNight) { ctx.shadowBlur = 20; ctx.shadowColor = color; }
                        ctx.beginPath(); ctx.arc(centerX, ly, circleSize, 0, Math.PI*2); ctx.fill();
                        if(glow) { ctx.shadowBlur = 0; ctx.fillStyle = "rgba(255,255,255,0.7)"; ctx.beginPath(); ctx.arc(centerX - 5, ly - 5, 4, 0, Math.PI*2); ctx.fill(); }
                    }
                    ctx.shadowBlur = 0;
                };
                drawTrafficLight(topY, this.h); drawTrafficLight(bottomY, this.h);
            }
        },
        update: function(timeScale) {
            if (state.current !== state.game) return;
            let add = this.position.length === 0 || (canvas.width - this.position[this.position.length-1].x >= this.spawnDistance);
            if (add) {
                let minVis = 50; let maxGapY = canvas.height - 150 - minVis - this.gap;
                let randomY = Math.random() * (maxGapY - minVis) + minVis;
                this.position.push({ x: canvas.width, y: randomY, gap: this.gap });
                if (Math.random() > 0.3) coins.push({ x: canvas.width + 20, y: randomY + (this.gap / 2), collected: false });
            }
            for (let p of this.position) {
                p.x -= gameSpeed * timeScale;
                let bottomY = p.y + p.gap;
                if (bird.x+bird.radius > p.x && bird.x-bird.radius < p.x+this.w) {
                    if (bird.y-bird.radius < p.y || bird.y+bird.radius > bottomY) bird.die();
                }
                if (p.x + this.w <= 0 && !p.passed) {
                    p.passed = true; this.position.shift(); score.value += 1;
                    if (score.value === 10) playSound('ses10');
                    else if (score.value === 50) playSound('ses50');
                    else if (score.value === 75) playSound('ses75');
                    else if (score.value === 100) playSound('ses100');
                    else if(score.value % 25 === 0) playSound('seviye');
                    else playSound('puan');
                    if(score.value % 5 === 0) gameSpeed += 0.15;
                    if(score.value % 15 === 0 && this.gap > 140) this.gap -= 5;
                    if(score.value > highScore) { highScore = score.value; localStorage.setItem("avell_highscore", highScore); }
                }
            }
        },
        reset: function() { this.position = []; gameSpeed = 1.8; this.gap = 190; }
    }

    function updateCoins(timeScale) {
        if (state.current !== state.game) return;
        for (let i = 0; i < coins.length; i++) {
            let c = coins[i]; c.x -= gameSpeed * timeScale;
            if (!c.collected) {
                ctx.save(); ctx.translate(c.x, c.y); ctx.rotate(c.x * -0.05);
                let tireGrad = ctx.createRadialGradient(0,0,12, 0,0,18); tireGrad.addColorStop(0, "#333"); tireGrad.addColorStop(0.7, "#111"); tireGrad.addColorStop(1, "#000");
                ctx.fillStyle = tireGrad; ctx.beginPath(); ctx.arc(0, 0, 18, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = "#222"; ctx.lineWidth = 0.5; ctx.beginPath(); ctx.arc(0, 0, 17, 0, Math.PI*2); ctx.stroke();
                let rimRadius = 12; let rimGrad = ctx.createRadialGradient(0,0,0, 0,0,rimRadius);
                rimGrad.addColorStop(0, "#eee"); rimGrad.addColorStop(0.6, "#999"); rimGrad.addColorStop(0.95, "#ccc"); rimGrad.addColorStop(1, "#666");
                ctx.fillStyle = rimGrad; ctx.beginPath(); ctx.arc(0, 0, rimRadius, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "#555"; for(let j=0; j<5; j++) { ctx.save(); ctx.rotate((Math.PI*2/5)*j); ctx.beginPath(); ctx.moveTo(-1.5, 3); ctx.lineTo(1.5, 3); ctx.lineTo(0.8, 11); ctx.lineTo(-0.8, 11); ctx.fill(); ctx.restore(); }
                ctx.fillStyle = "#222"; ctx.beginPath(); ctx.arc(0, 0, 3, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "#fff"; for(let j=0; j<5; j++) { ctx.save(); ctx.rotate((Math.PI*2/5)*j + Math.PI/10); ctx.beginPath(); ctx.arc(0, 5.5, 1, 0, Math.PI*2); ctx.fill(); ctx.restore(); }
                ctx.restore();
                if (Math.sqrt((bird.x-c.x)**2 + (bird.y-c.y)**2) < bird.radius + 18) {
                    c.collected = true; totalCoins++; gameCoinCountTxt.innerText = totalCoins;
                    localStorage.setItem("avell_coins", totalCoins); playSound('coin');
                }
            } else { coins.splice(i, 1); i--; }
        }
    }

    function updateParticles() {
        for(let i=0; i<particles.length; i++) {
            let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.02;
            ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.fillRect(p.x, p.y, 5, 5); ctx.globalAlpha = 1.0;
            if(p.life <= 0) { particles.splice(i, 1); i--; }
        }
    }

    const score = {
        value: 0,
        draw: function() {
            ctx.fillStyle = isNight ? "#FFF" : "#000";
            if (state.current == state.getReady) {
                ctx.font = "40px Bangers"; ctx.textAlign = "center"; ctx.fillText("BA≈ûLA!", canvas.width/2, 300); ctx.textAlign = "start";
            }
            else if (state.current == state.game) { ctx.font = "60px Bangers"; ctx.fillText(this.value, canvas.width/2-15, 80); } 
            else if (state.current == state.over) {
                ctx.font = "60px Bangers"; ctx.fillStyle = "red"; ctx.strokeStyle = "white"; ctx.lineWidth=3;
                ctx.textAlign="center"; ctx.fillText("AVELL!!!", canvas.width/2, 200); ctx.strokeText("AVELL!!!", canvas.width/2, 200);
                ctx.fillStyle = "white"; ctx.font = "40px Bangers"; ctx.fillText("Skor: " + this.value, canvas.width/2, 260);
                ctx.fillStyle = "gold"; ctx.font = "30px Bangers"; ctx.fillText("Rekor: " + highScore, canvas.width/2, 300);
                ctx.font = "20px Bangers"; ctx.fillStyle = "#888"; ctx.fillText("Tƒ±kla ve Tekrar Dene", canvas.width/2, 360); ctx.textAlign="start";
            }
        },
        reset: function() { this.value = 0; }
    }

    let streetlights = [], roadOffset = 0, stars = [], clouds = [];
    function initBackground() {
        stars = []; for(let i=0;i<30;i++) stars.push({x:Math.random()*canvas.width, y:Math.random()*200, r:Math.random()*1.5});
        clouds = []; for(let i=0;i<5;i++) clouds.push({x:Math.random()*canvas.width, y:Math.random()*150, r:20+Math.random()*20});
        streetlights = [];
    }
    initBackground();

    function drawWorld(timeScale) {
        let roadTopY = canvas.height - 150;
        if (isNight) {
            let g = ctx.createLinearGradient(0,0,0,roadTopY); g.addColorStop(0,"#050510"); g.addColorStop(1,"#1a1a2e"); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,roadTopY);
            ctx.fillStyle="white"; for(let s of stars) { ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill(); }
        } else {
            let g = ctx.createLinearGradient(0,0,0,roadTopY); g.addColorStop(0,"#87CEEB"); g.addColorStop(1,"#E0F7FA"); ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,roadTopY);
            ctx.fillStyle="rgba(255,255,255,0.8)"; for(let c of clouds) { ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.arc(c.x+20,c.y+10,c.r*0.8,0,Math.PI*2); ctx.fill(); }
        }

        if (state.current == state.game) {
            if (streetlights.length === 0 || canvas.width - streetlights[streetlights.length-1].x >= 300) streetlights.push({ x: canvas.width + 50, h: 120 });
        }
        for (let i = 0; i < streetlights.length; i++) {
            let sl = streetlights[i]; let poleX = sl.x; let poleBaseY = roadTopY + 20; let poleTopY = poleBaseY - sl.h;
            if(isNight) {
                let lightGrad = ctx.createRadialGradient(poleX - 20, poleTopY, 5, poleX, roadTopY + 40, 120);
                lightGrad.addColorStop(0, "rgba(255, 255, 200, 0.5)"); lightGrad.addColorStop(1, "rgba(0,0,0,0)");
                ctx.fillStyle = lightGrad; ctx.beginPath(); ctx.moveTo(poleX-40, roadTopY+50); ctx.lineTo(poleX-20, poleTopY); ctx.lineTo(poleX+20, poleTopY); ctx.lineTo(poleX+60, roadTopY+50); ctx.fill();
            }
            ctx.fillStyle = "#333"; ctx.fillRect(poleX - 3, poleTopY, 6, sl.h);
            ctx.fillStyle = isNight ? "#FFD700" : "#555"; ctx.beginPath(); ctx.moveTo(poleX - 15, poleTopY); ctx.lineTo(poleX + 5, poleTopY); ctx.lineTo(poleX + 5, poleTopY - 10); ctx.lineTo(poleX - 25, poleTopY - 5); ctx.fill();
            if (state.current == state.game) sl.x -= (gameSpeed * 0.5) * timeScale;
            if(sl.x < -50) { streetlights.splice(i, 1); i--; }
        }

        ctx.fillStyle = isNight ? "#222" : "#444"; ctx.fillRect(0, roadTopY, canvas.width, canvas.height - roadTopY);
        let stripeW = 40; 
        if (state.current == state.game) roadOffset = (roadOffset + gameSpeed * timeScale) % (stripeW * 2);
        for(let i = -stripeW * 2; i < canvas.width; i += stripeW) {
            let x = i - roadOffset;
            ctx.fillStyle = "#FFD700"; ctx.fillRect(x, roadTopY, stripeW, 12);
            ctx.fillStyle = "#111"; ctx.fillRect(x + stripeW, roadTopY, stripeW, 12);
        }
        let laneY = roadTopY + (canvas.height - roadTopY) / 2 + 10;
        for(let i = -60; i < canvas.width; i += 60) {
            let lineX = i - roadOffset; 
            // 3D YOL √áƒ∞ZGƒ∞Sƒ∞ (KATMANLI)
            ctx.fillStyle = isNight ? "#444" : "#999"; ctx.fillRect(lineX, laneY+5, 30, 1); // G√∂lge
            ctx.fillStyle = isNight ? "#888" : "#EEE"; ctx.fillRect(lineX, laneY+1, 30, 4); // G√∂vde
            ctx.fillStyle = isNight ? "#BBB" : "#FFF"; ctx.fillRect(lineX, laneY, 30, 1); // Parlaklƒ±k
        }
        if (state.current == state.game && !isNight) { for(let c of clouds) { c.x -= (gameSpeed * 0.2) * timeScale; if(c.x<-50) c.x=canvas.width+50; } }
    }

    function draw(timeScale) {
        ctx.save();
        if (shakeIntensity > 0) {
            let dx = (Math.random() - 0.5) * shakeIntensity; let dy = (Math.random() - 0.5) * shakeIntensity;
            ctx.translate(dx, dy); shakeIntensity *= 0.9; if(shakeIntensity < 0.5) shakeIntensity = 0;
        }
        drawWorld(timeScale);
        pipes.draw(); updateCoins(timeScale); updateParticles();
        if (state.current != state.select && state.current != state.over) bird.draw();
        score.draw();
        ctx.restore();
    }

    function loop(timestamp) {
        if (!lastTime) lastTime = timestamp;
        let deltaTime = timestamp - lastTime;
        lastTime = timestamp;
        if (deltaTime > 100) deltaTime = 16; 
        let timeScale = deltaTime / (1000 / 60);

        bird.update(timeScale);
        pipes.update(timeScale);
        draw(timeScale);
        requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(() => {})); }
</script>
</body>
</html>